let _ta=t=>[].slice.apply(t),_et=t=>t.touches&&t.touches.length,_ne=t=>document.createElement(t),_nes=t=>document.createElementNS("http://www.w3.org/2000/svg",t),_mm=t=>{let e=t.slice(0).sort((t,e)=>t-e);return[e[0],e.pop()]};class TGraph{constructor(t,e,s=!1){this._el=t;let i=this._el.getBoundingClientRect(),h=Math.max(i.width,200),n=Math.max(i.height,300);this._black=s,this._lw=80,this._pheight=100,this._bheight=100,this._aheight=30,this._wndBw=10,this._wndX=-10,this._wndW=100,this._showPt=!0,this._wndAct=!1,this._el.style.backgroundColor=this._cl[5],this._el.style.padding=this._wndBw+"px",this._el.style.width=h+"px",this._el.style.overflow="hidden",this._width=h-2*this._wndBw,this._height=n-this._pheight-this._bheight,this._series=new TSeries(this,e),this.init()}setMode(t){this._black=t,this._el.style.backgroundColor=this._cl[5],[this._wndL,this._wndR].map(t=>t.style.backgroundColor=this._cl[0]),this._wnd.style.borderColor=this._cl[2],this._wnd.style.backgroundColor=this._cl[1],this._btDraw(),this._Pt.style.opacity=0}get _cl(){return this._black?["rgba(85, 92, 101, 0.586)","rgba(219, 229, 236, 0.06)","#ddeaf360","rgb(210, 231, 255)","#e3e3e3","#242f3e","#263241","#fff","#202b3a","#304052"]:["rgba(221, 230, 243, 0.386)","#ddeaf329","#ddeaf3d9","#9aa6ae","#e3e3e3","#fff","#fff","#000","#e3e3e3","#e7edf1"]}get _mgHeight(){return this._height-this._aheight}init(){this._svg=_nes("svg"),this._svg.setAttribute("height",this._height),this._svg.setAttribute("width",this._width),this._el.appendChild(this._svg),this._pvwG=_nes("g");let t=_ne("div"),e=_nes("svg");e.setAttribute("height","100"),t.style.position="relative",t.style.height=this._pheight+"px",e.appendChild(this._pvwG),t.appendChild(e),this._el.appendChild(t),this._wndL=t.cloneNode(),this._wndL.style=`position:absolute;top:0;height:${this._pheight}px;left:0;width:0;background-color:${this._cl[0]};padding-left:0;`,t.appendChild(this._wndL),this._wndR=this._wndL.cloneNode(),this._wndR.style.left=this._wndX+this._wndW+"px",this._wndR.style.width=this._width-this._wndW-this._wndX+"px",t.appendChild(this._wndR),this._wnd=this._wndL.cloneNode(),this._wnd.style.cursor="move",this._wnd.style.height=this._pheight-6+"px",this._wnd.style.width=this._wndW+"px",this._wnd.style.border="solid 3px "+this._cl[2],this._wnd.style["background-color"]=this._cl[1],this._wnd.style["border-left-width"]=this._wndBw+"px",this._wnd.style["border-right-width"]=this._wndBw+"px",this._wnd.style["border-radius"]="3px",t.appendChild(this._wnd),this._G=_nes("g"),this._G.style.transition="0.5s",this._wndInitEvents(),this._series._lines.map(t=>{this._G.appendChild(t.el),this._pvwG.appendChild(t.el.cloneNode())}),this._G.childNodes.forEach(t=>t.style["stroke-width"]=2),this._pvwG.style.transform="scaleY("+ +this._pheight/this._height+")",this._xLabels=this._series.xLabels(),this._yLabels=this._series.yLabels(),this._svg.appendChild(this._xLabels),this._svg.appendChild(this._yLabels),this._svg.appendChild(this._G),this._buttons=_ne("div"),this._btDraw(),this._el.appendChild(this._buttons),this.wndUpd(30,100),this._showPt&&this._PtDraw()}_btDraw(){this._buttons.innerHTML="";let t=t=>e=>{this._Pt.style.opacity=0,t.toggle();let s=e.target.getElementsByTagName("span").item(0);s.innerHTML=t._enabled?"&#x2713;":"",s.style.backgroundColor=t._enabled?t._color:this._cl[5],this.wndUpd()};for(let e of this._series._lines){let s=_ne("div");s.className="btn-graph",s.style=`color:${this._cl[7]};cursor:pointer;float:left;padding:3px;border-radius:17px;border:solid 2px ${this._cl[9]};background-color:${this._cl[6]};margin:15px;height:33px;line-height:33px;text-align:center;min-width:70px;`,s.innerHTML=`<span style="pointer-events:none;display:inline-block;width:20px;height:20px;font-size:22px;line-height:22px;background-color:${e._color};border:solid 2px ${e._color};border-radius:11px;color:white;margin:5px;float:left;">&#x2713;</span>${e._label}`,this._buttons.appendChild(s),s.addEventListener("click",t(e))}}_PtDraw(){this._Pt=_nes("g");let t=_nes("line"),e=_nes("g"),s=_nes("rect"),i=_nes("text"),h=[],n=[],l=[];this._Pt.style.opacity=0,this._Pt.appendChild(t),this._Pt.appendChild(e),this._Pt.appendChild(i),e.style="transition:0.5s",s.setAttribute("x","-40px"),s.setAttribute("rx","15px"),s.setAttribute("ry","15px"),s.setAttribute("height","80px"),s.setAttribute("vector-effect","non-scaling-stroke"),i.setAttribute("text-anchor","middle"),i.setAttribute("y","25"),i.setAttribute("vector-effect","non-scaling-stroke"),i.setAttribute("shape-rendering","optimizeSpeed"),i.innerHTML="There whould be label",e.appendChild(s),e.appendChild(i),t.style.strokeWidth="1px",["y1","x1","x2"].map(e=>t.setAttribute(e,0)),t.setAttribute("y2",this._height),t.setAttribute("vector-effect","non-scaling-stroke"),this._series._lines.map((t,s)=>{let i=_nes("circle"),_=_nes("text"),[,r]=this._scp;i.setAttribute("r",4),i.setAttribute("vector-effect","non-scaling-stroke"),i.style.stroke=t._color,this._Pt.appendChild(i),l.push(i),_.setAttribute("x",80*s),_.setAttribute("y","45"),_.setAttribute("vector-effect","non-scaling-stroke"),_.setAttribute("shape-rendering","optimizeSpeed"),_.setAttribute("text-anchor","middle"),_.setAttribute("dominant-baseline","middle"),_.style=`fill: ${t._color}`,e.appendChild(_),h.push(_);let a=_.cloneNode();a.style.fontSize="12px",a.setAttribute("y","60"),a.innerHTML=t._label,n.push(a),e.appendChild(a)});let _=()=>{s.style=`stroke:${this._cl[8]};stroke-width:2px;fill:${this._cl[6]}`,t.style.stroke=this._cl[3],i.style=`fill:${this._cl[7]}`,l.map(t=>t.style.fill=this._cl[5])};this._G.appendChild(this._Pt);let r=this._svg.createSVGPoint(),a=!0,d=t=>{let _=_et(t)?t.touches[0]:t;r.x=_.clientX,r.y=_.clientY;let[a,d,o]=this._series.ozd,[,p]=this._scp,c=r.matrixTransform(this._G.getScreenCTM().inverse()),w=c.x*o,g=Math.max(0,Math.floor(w)),m=g+1;this._Pt.setAttribute("transform",`translate(${c.x} 0) scale(${1/p} 1)`);let u=0,b=[];this._series._lines.map((t,e)=>{if(l[e].style.opacity=+t._enabled,h[e].style.opacity=+t._enabled,n[e].style.opacity=+t._enabled,!t._enabled)return;let s=t._data[g],i=s-(t._data[m]-s)*(g-w),_=this._mgHeight-(i-a)*d;l[e].setAttribute("cy",_),b.push(_),h[e].innerHTML=Math.floor(i),h[e].setAttribute("x",80*u),n[e].setAttribute("x",80*u++)});let y=Math.max(140,80*u),f=Math.min(this._mgHeight,b.reduce((t,e)=>e>t&&e<t+80?e+50-e%50:t,0));e.style.transform=`translateY(${f}px)`,s.setAttribute("width",y),i.setAttribute("x",y/2-40),i.innerHTML=this._series._lbl(g,"wmd")},o=t=>{t.preventDefault(),a&&(a=requestAnimationFrame(()=>(a=!0)&&d(t))&&!1)},p=t=>{this._svg.removeEventListener(_et(t)?"touchmove":"mousemove",o)},c=t=>{d(t),_(),this._Pt.style.opacity=1,this._svg.addEventListener(_et(t)?"touchmove":"mousemove",o),this._svg.addEventListener(_et(t)?"touchend":"mouseup",p,{once:!0})};["touchstart","mousedown"].map(t=>this._svg.addEventListener(t,c))}_wndInitEvents(){let t=0,e=0,s=!0,i=s=>{let i=_et(s)?s.touches[0].clientX:s.clientX,h=i-t+e;if("move"===this._wndAct)this._wndX=Math.min(Math.max(-this._wndBw,h),this._width-this._wndW-this._wndBw);else if("right"===this._wndAct)this._wndW=Math.min(Math.max(this._wndBw,i-this._wndX-2*this._wndBw),this._width-this._wndX-this._wndBw);else if("left"===this._wndAct){let t=Math.max(-this._wndBw,h),e=this._wndX+this._wndW-this._wndBw;this._wndW=Math.max(this._wndBw,this._wndW+this._wndX-t),this._wndX=Math.min(t,e)}},h=t=>{_et(t)||t.preventDefault(),s&&this._wndAct&&(i(t),s=requestAnimationFrame(()=>(s=!0)&&this.wndUpd())&&!1)},n=t=>{t.preventDefault(),this._wnd.style.cursor="pointer",this._wndAct=!1,document.removeEventListener(_et(t)?"touchmove":"mousemove",h)},l=s=>{s.preventDefault(),this._Pt&&(this._Pt.style.opacity=0),e=this._wndX;let i=(t=_et(s)?s.touches[0].clientX:s.clientX)-this._wndX-3*this._wndBw;this._wnd.style.cursor="col-resize",this._wndAct=i<0?"left":i>this._wndW?"right":"move",this._wnd.style.cursor="move"===this._wndAct?"move":"col-resize";let l=_et(s)?["touchmove","touchend"]:["mousemove","mouseup"];document.addEventListener(l[0],h),document.addEventListener(l[1],n,{once:!0})};this._wnd.addEventListener("mousedown",l,!1),this._wnd.addEventListener("touchstart",l,!1)}wndUpd(){this._wndL.style.left=-this._wndBw+"px",this._wndL.style.width=this._wndX+this._wndBw+"px",this._wnd.style.left=this._wndX+"px",this._wnd.style.width=this._wndW+"px",this._wndR.style.left=this._wndX+this._wndW+this._wndBw+"px",this._wndR.style.width=this._width-(this._wndX+this._wndW)+"px",this.show(this._wndX+this._wndBw,this._wndW)}get _x1(){return this._wndX+this._wndBw}get _x2(){return this._wndX+this._wndBw+this._wndW}get _scp(){let t=this._x1,e=this._wndW,s=this._series._lines[0],i=s._data.length,h=s._step,n=i/this._width,l=(t+e)*n,_=h*(t*n),r=(l?Math.min(l,i):i)*h;return[_,this._width/(r-_||1)]}show(){let[t,e,s]=this._series.ozd,[i,h]=this._scp,n=this._x1*s,l=this._x2*s;this._G.setAttribute("transform","translate("+-i*h+" 0) scale("+h+" 1)"),this.updLabelsX(n,l),this._series.rescale(n,l),this.updLabelsY(t/e,this._mgHeight/e)}updLabelsY(){if(this._yUpd=(this._yUpd||0)+1,this._yUpd>1)return this._yUpdt&&clearTimeout(this._yUpdt),this._yUpdt=setTimeout(()=>{this._yUpd=0,this.updLabelsY()},120);let t=_ta(this._yLabels.getElementsByTagName("text")).map(t=>+t.innerHTML),[e]=this._series.ozd,s=(t,e,s,i)=>_ta(t.getElementsByTagName("text")).map((t,h)=>{t.style.transform=`translateY(${s(h)}px)`,t.style.opacity=e,i&&(t.style.transition=i)}),i=this._series.yLabels(),h=_ta(i.getElementsByTagName("text")).map(t=>+t.innerHTML);s(i,.5,e=>(t=>t>0?50:t&&-50)(t[e]-h[e]),"0.5s"),this._yLabels.innerHTML="",this._yLabels.appendChild(i),setTimeout(()=>s(i,1,()=>0),20)}updLabelsX(t,e){let s=this._series._lines[0],[,i]=this._scp,h=s._step*i,n=t*h,l="";for(;h*(l||1)<50||(l||0)%2;)l=(l||1)+1;this._xLabels.style.transform=`translateX(${-n}px)`,[].slice.call(this._xLabels.getElementsByTagName("text")||[]).map((t,e)=>{let s=this._wndX<0&&!e?30:h*e-this._lw*e;t.style.transform=`translateX(${s}px)`,l&&!t.classList.contains("ml"+l)?t.style.opacity=0:t.style.opacity=1})}}class TSeries{constructor(t,e={}){this._labelsFormat="md",this._labels=[],this._lines=[],this._zoom=1,this._graph=t,TSeries.validateData(e)&&this.load(e)}get ozd(){let t=this._lines[0];return[t._offset,t._zoom,t._data.length/this._graph._width]}yLabels(){let t=this._lines[0]._offset,e=this._lines[0]._zoom,s=_nes("g");s.style.transition="0.5s";for(let t=this._graph._mgHeight;t>=0;t-=50)s.innerHTML+=`<line x1="0" y1="${t}" x2="${this._graph._width}" y2="${t}" style="stroke:${this._graph._cl[3]};opacity:0.5;" vector-effect="non-scaling-stroke" shape-rendering=optimizeSpeed />`;if(this._lines.filter(t=>t._enabled).length)for(let i=this._graph._mgHeight-1,h=0;i>=0;i-=50,h++)s.innerHTML+=`<text x="10" y="${i-10}" style="fill:${this._graph._cl[3]};font-size:14px;" vector-effect="non-scaling-stroke" shape-rendering=optimizeSpeed>${Math.round(t+50*h/e)}</text>`;return s}_lbl(t,e=null){e=e||this._labelsFormat;let s=this._labels[t];if("md"===e){return new Intl.DateTimeFormat("en",{month:"short",day:"numeric"}).format(new Date(+s))}return"wmd"===e?new Date(+s).toDateString().replace(/(^[^\s]+)(.*)?\s[^\s]+$/,"$1,$2"):s}xLabels(){let t=_nes("g"),e=t=>{let e=[];for(let s=2;s<=t;s++)t%s==0&&e.push(s);return"ml"+e.join(" ml")};t.style.transition="0.5s";for(let s=0;s<this._labels.length;s++){let i=this._lbl(s),h=e(s);t.innerHTML+=`<text class="${h}" text-anchor="middle" x="${s*this._graph._lw}" y="${this._graph._height-10}" style="transition: 0.5s;fill: ${this._graph._cl[3]};font-size: 14px;" vector-effect="non-scaling-stroke" shape-rendering=optimizeSpeed>${i}</text>`}return t}load(t){this._labels=t.columns.find(e=>e[0]===t.types.x),this._lines=t.columns.filter(e=>e[0]!==t.types.x).map(e=>{let s=t.names&&t.names[e[0]]||"",i=t.colors&&t.colors[e[0]]||"black";return new TLine(this._graph,e[0],s,i,e.slice(1))}),this._labels.shift(),this.rescale()}rescale(t=null,e=null){t=Math.floor(Math.min(Math.max(t||0,0),this._labels.length)),e=Math.ceil(Math.max(Math.min(e||this._labels.length,this._labels.length),0));let[s,i]=this._lines.filter(t=>t._enabled).reduce((s,i)=>{let[h,n]=i.mnmx(t,e);return[Math.min(h,s[0]),Math.max(n,s[1])]},[1/0,-1/0]),h=this._graph._mgHeight/(i-s),n=s;for(let t of this._lines)t.rescale(n,h)}static validateData(t){if(!t)return!1;for(let e of["columns","types"])if(!t[e])return!1;if(!t.columns.length)return!1;if(!t.types.x)return!1;for(let e in t.types)if(!["x","line"].includes(t.types[e]))return!1;return!0}}class TLine{constructor(t,e,s,i,h,n=0){this._el=null,this._enabled=!0,this._zoom=1,this._offset=0,this._graph=t,this._name=e,this._label=s,this._color=i,[this._min,this._max]=_mm(h),this._zoom=n||this._max/this._graph._mgHeight,this._data=h}mnmx(t,e){return _mm(this._data.slice(t,e))}get el(){if(this._el)return this._el;this._step=this._graph._width/this._data.length;let t=[];for(let e=0;e<this._data.length;e++)t.push(this._step*e+","+this._data[e]);return this._el=_nes("polyline"),this._el.setAttribute("vector-effect","non-scaling-stroke"),this._el.style=`transform-origin: 0 0;transition: 0.5s;fill:none;stroke:${this._color};stroke-width:1`,this._el.setAttribute("points",t.join(" ")),this.rescale(this._offset,this._zoom),this._el}rescale(t,e){this._offset=t,this._zoom=e,this._el&&this._el.setAttribute("transform",`translate(0 ${this._graph._mgHeight+this._offset*this._zoom}) scale(1 -${this._zoom})`)}toggle(){this._enabled=!this._enabled,this._el.style.opacity=this._enabled?1:0}}