let _et=t=>t.touches&&t.touches.length,_ne=t=>document.createElement(t),_nes=t=>document.createElementNS("http://www.w3.org/2000/svg",t),_mm=t=>{let e=t.slice(0).sort((t,e)=>t-e);return[e[0],e.pop()]};class TGraph{constructor(t,e,s=!1){this._lw=80,this._pheight=100,this._bheight=100,this._aheight=30,this._wndBw=10,this._wndX=-10,this._wndW=100,this._cl=s?["rgba(85, 92, 101, 0.586)","rgba(219, 229, 236, 0.06)","#ddeaf3d9","#445365","#e3e3e3","#242f3e","#263241","#fff","#202b3a","#304052"]:["rgba(221, 230, 243, 0.586)","#ddeaf329","#ddeaf3d9","#9aa6ae","#e3e3e3","#fff","#fff","#000","#e3e3e3","#e7edf1"],this._showPt=!0,this._wndAct=!1,this._el=t,this._el.style.backgroundColor=this._cl[5];let i=this._el.getBoundingClientRect();i.width&&(this._width=i.width,this._height=i.height-this._pheight-this._bheight,this._series=new TSeries(this,e),this.init())}get _mgHeight(){return this._height-this._aheight}init(){this._svg=_nes("svg"),this._svg.setAttribute("height",this._height),this._el.appendChild(this._svg),this._previewGraph=_nes("g");let t=_ne("div"),e=_nes("svg");e.setAttribute("height","100"),t.style.position="relative",t.style.height=this._pheight+"px",e.appendChild(this._previewGraph),t.appendChild(e),this._el.appendChild(t),this._wndL=t.cloneNode(),this._wndL.style=`position:absolute;top:0;height:${this._pheight}px;left:0;width:0;background-color:${this._cl[0]};padding-left:0;`,t.appendChild(this._wndL),this._wndR=this._wndL.cloneNode(),this._wndR.style.left=this._wndX+this._wndW+"px",this._wndR.style.width=this._width-this._wndW-this._wndX+"px",t.appendChild(this._wndR),this._wnd=this._wndL.cloneNode(),this._wnd.style.cursor="move",this._wnd.style.height=this._pheight-6+"px",this._wnd.style.width=this._wndW+"px",this._wnd.style.border="solid 3px "+this._cl[2],this._wnd.style["border-left-width"]=this._wndBw+"px",this._wnd.style["border-right-width"]=this._wndBw+"px",this._wnd.style["border-radius"]="3px",this._wnd.style["background-color"]=this._cl[1],t.appendChild(this._wnd),this._mainGraph=_nes("g"),this._mainGraph.style.transition="0.5s",this._wndInitEvents(),this._series.lines().map(t=>{this._mainGraph.appendChild(t.el),this._previewGraph.appendChild(t.el.cloneNode())}),this._mainGraph.childNodes.forEach(t=>t.style["stroke-width"]=2),this._previewGraph.style.transform="scaleY("+ +this._pheight/this._height+")",this._xLabels=this._series.xLabels(),this._yLabels=this._series.yLabels(),this._svg.appendChild(this._xLabels),this._svg.appendChild(this._yLabels),this._svg.appendChild(this._mainGraph),this._buttons=_ne("div");let s=t=>e=>{this._Pt.style.opacity=0,t.toggle();let s=e.target.getElementsByTagName("span").item(0);s.innerHTML=t._enabled?"&#x2713;":"",s.style.backgroundColor=t._enabled?t._color:this._cl[5],this.wndUpd()};for(let t of this._series.lines()){let e=_ne("div");e.className="btn-graph",e.style=`color:${this._cl[7]};cursor:pointer;float:left;padding:3px;border-radius:17px;border:solid 2px ${this._cl[9]};background-color:${this._cl[6]};margin:15px;height:32px;line-height:32px;text-align:center;min-width:70px;`,e.innerHTML=`<span style="pointer-events:none;display:inline-block;width:20px;height:18px;font-size:22px;line-height:20px;background-color:${t._color};border:solid 2px ${t._color};border-radius:11px;color:white;margin:5px;float:left;">&#x2713;</span>${t._name}`,this._buttons.appendChild(e),e.addEventListener("click",s(t))}this._el.appendChild(this._buttons),this.wndUpd(30,100),this._showPt&&this._PtDraw()}_PtDraw(){this._Pt=_nes("g");let t=_nes("line"),e=_nes("rect"),s=_nes("text"),i=[],h=[],n=[];this._Pt.style.opacity=0,this._Pt.appendChild(t),this._Pt.appendChild(e),this._Pt.appendChild(s),e.setAttribute("x","-40px"),e.setAttribute("rx","15px"),e.setAttribute("ry","15px"),e.setAttribute("height","80px"),e.setAttribute("vector-effect","non-scaling-stroke"),s.setAttribute("text-anchor","middle"),s.setAttribute("y","25"),s.setAttribute("vector-effect","non-scaling-stroke"),s.setAttribute("shape-rendering","optimizeSpeed"),s.style=`fill:${this._cl[7]}`,s.innerHTML="There whould be label",e.style.stroke=this._cl[8],e.style.strokeWidth="2px",e.style.fill=this._cl[6],t.style.stroke=this._cl[3],t.style.strokeWidth="2px",["y1","x1","x2"].map(e=>t.setAttribute(e,0)),t.setAttribute("y2",this._height),t.setAttribute("vector-effect","non-scaling-stroke"),this._series._lines.map((t,e)=>{let s=_nes("circle"),l=_nes("text"),[,_]=this._scp;s.setAttribute("r",4),s.setAttribute("vector-effect","non-scaling-stroke"),s.style.stroke=t._color,s.style.fill=this._cl[5],this._Pt.appendChild(s),n.push(s),l.setAttribute("x",80*e),l.setAttribute("y","45"),l.setAttribute("vector-effect","non-scaling-stroke"),l.setAttribute("shape-rendering","optimizeSpeed"),l.setAttribute("text-anchor","middle"),l.setAttribute("dominant-baseline","middle"),l.style=`fill: ${t._color}`,this._Pt.appendChild(l),i.push(l);let r=l.cloneNode();r.style.fontSize="12px",r.setAttribute("y","60"),r.innerHTML=t._name,h.push(r),this._Pt.appendChild(r)}),this._mainGraph.appendChild(this._Pt);let l=this._svg.createSVGPoint(),_=!0,r=t=>{let _=_et(t)?t.touches[0]:t;l.x=_.clientX,l.y=_.clientY;let[r,a,d]=this._series.ozd,[,o]=this._scp,p=l.matrixTransform(this._mainGraph.getScreenCTM().inverse()),c=p.x*d,w=Math.floor(c),m=w+1;this._Pt.style.transform=`translateX(${p.x}px) scaleX(${1/o})`;let g=0,u=[];this._series._lines.map((t,e)=>{if(n[e].style.opacity=+t._enabled,i[e].style.opacity=+t._enabled,h[e].style.opacity=+t._enabled,!t._enabled)return;let s=t._data[w],l=s-(t._data[m]-s)*(w-c),_=this._mgHeight-(l-r)*a;n[e].setAttribute("cy",_),u.push(_),i[e].innerHTML=Math.floor(l),i[e].setAttribute("x",80*g),h[e].setAttribute("x",80*g++)});let f=[25,105],b=!0,y=Math.max(140,80*g);do{b=u.reduce((t,e)=>t&&(e<f[0]||e>f[1]),!1)}while(b&&(f=f.map(t=>t+50))[1]<this._mgHeight);f[1]<this._mgHeight&&(f=[25,105]),e.setAttribute("width",y),s.setAttribute("x",y/2-40),s.innerHTML=this._series._lbl(w,"wmd")},a=t=>{_et(t)||t.preventDefault(),_&&(_=requestAnimationFrame(()=>(_=!0)&&r(t))&&!1)},d=t=>{this._svg.removeEventListener(_et(t)?"touchmove":"mousemove",a)},o=t=>{r(t),this._Pt.style.opacity=1,this._svg.addEventListener(_et(t)?"touchmove":"mousemove",a),this._svg.addEventListener(_et(t)?"touchend":"mouseup",d,{once:!0})};["touchstart","mousedown"].map(t=>this._svg.addEventListener(t,o))}_wndInitEvents(){let t=0,e=0,s=!0,i=s=>{let i=_et(s)?s.touches[0].clientX:s.clientX,h=i-t+e;"move"===this._wndAct?this._wndX=Math.min(Math.max(-this._wndBw,h),this._width-this._wndW-this._wndBw):"right"===this._wndAct?this._wndW=Math.min(Math.max(0,i-this._wndX-2*this._wndBw),this._width):"left"===this._wndAct&&(this._wndW=Math.min(Math.max(0,this._wndW+(this._wndX-h)),this._width),this._wndX=Math.min(Math.max(-this._wndBw,h),this._width-2*this._wndBw))},h=t=>{_et(t)||t.preventDefault(),s&&this._wndAct&&(i(t),s=requestAnimationFrame(()=>(s=!0)&&this.wndUpd())&&!1)},n=t=>{t.preventDefault(),this._wnd.style.cursor="pointer",this._wndAct=!1,document.removeEventListener(_et(t)?"touchmove":"mousemove",h)},l=s=>{s.preventDefault(),this._Pt&&(this._Pt.style.opacity=0),e=this._wndX;let i=(t=_et(s)?s.touches[0].clientX:s.clientX)-this._wndX-2*this._wndBw;this._wnd.style.cursor="col-resize",this._wndAct=i<0?"left":i>this._wndW?"right":"move",this._wnd.style.cursor="move"===this._wndAct?"move":"col-resize";let l=_et(s)?["touchmove","touchend"]:["mousemove","mouseup"];document.addEventListener(l[0],h),document.addEventListener(l[1],n,{once:!0})};this._wnd.addEventListener("mousedown",l,!1),this._wnd.addEventListener("touchstart",l,!1)}wndUpd(){this._wndL.style.left="0px",this._wndL.style.width=this._wndX+this._wndBw+"px",this._wnd.style.left=this._wndX+"px",this._wnd.style.width=this._wndW+"px",this._wndR.style.left=this._wndX+this._wndW+this._wndBw+"px",this._wndR.style.width=this._width-(this._wndX+this._wndW)+"px",this.show(this._wndX+this._wndBw,this._wndW)}get _x1(){return this._wndX+this._wndBw}get _x2(){return this._wndX+this._wndBw+this._wndW}get _scp(){let t=this._x1,e=this._wndW,s=this._series._lines[0],i=s._data.length,h=s._step,n=i/this._width,l=(t+e)*n,_=h*(t*n),r=(l?Math.min(l,i):i)*h;return[_,this._width/(r-_||1)]}show(){let[t,e,s]=this._series.ozd,[i,h]=this._scp,n=this._x1*s,l=this._x2*s;this._mainGraph.style.transform="translateX("+-i*h+"px) scaleX("+h+")",this.updLabelsX(n,l),this._series.rescale(n,l),this.updLabelsY(t/e,this._mgHeight/e)}updLabelsY(t,e){this._yLabels.innerHTML="",this._yLabels.appendChild(this._series.yLabels(t,e))}updLabelsX(t,e){let s=this._series.lines()[0],[,i]=this._scp,h=s._step*i,n=t*h,l="";for(;h*(l||1)<50||(l||0)%2;)l=(l||1)+1;this._xLabels.style.transform=`translateX(${-n}px)`,[].slice.call(this._xLabels.getElementsByTagName("text")||[]).map((t,e)=>{t.style.transform=`translateX(${h*e-this._lw*e}px)`,l&&!t.classList.contains("ml"+l)?t.style.opacity=0:t.style.opacity=1})}}class TSeries{constructor(t,e={}){this._labelsFormat="timestamp:day",this._labels=[],this._lines=[],this._zoom=1,this._graph=t,TSeries.validateData(e)&&this.load(e)}get ozd(){let t=this.lines()[0];return[t._offset,t._zoom,t._data.length/this._graph._width]}yLabels(t=null,e=null){let s=this._lines[0]._offset,i=this._lines[0]._zoom,h=_nes("g");h.style.transition="0.5s";for(let t=this._graph._mgHeight;t>=0;t-=50)h.innerHTML+=`<line x1="0" y1="${t}" x2="${this._graph._width}" y2="${t}" style="stroke:${this._graph._cl[3]};opacity:0.5;" vector-effect="non-scaling-stroke" shape-rendering=optimizeSpeed />`;if(this.lines().filter(t=>t._enabled).length)for(let t=this._graph._mgHeight-1,e=0;t>=0;t-=50,e++)h.innerHTML+=`<text x="10" y="${t-10}" style="fill:${this._graph._cl[3]};font-size:14px;" vector-effect="non-scaling-stroke" shape-rendering=optimizeSpeed>${Math.round(s+50*e/i)}</text>`;return h}_lbl(t,e=null){e=e||this._labelsFormat;let s=this._labels[t];if("timestamp:day"===e){return new Intl.DateTimeFormat("en",{month:"short",day:"numeric"}).format(new Date(+s))}return"wmd"===e?new Date(+s).toDateString().replace(/(^[^\s]+)(.*)?\s[^\s]+$/,"$1,$2"):s}xLabels(){let t=_nes("g"),e=t=>{let e=[];for(let s=2;s<=t;s++)t%s==0&&e.push(s);return"ml"+e.join(" ml")};t.style.transition="0.5s";for(let s=0;s<this._labels.length;s++){let i=this._lbl(s),h=e(s);t.innerHTML+=`<text class="${h}" text-anchor="middle" x="${s*this._graph._lw}" y="${this._graph._height-10}" style="transition: 0.5s;fill: ${this._graph._cl[3]};font-size: 14px;" vector-effect="non-scaling-stroke" shape-rendering=optimizeSpeed>${i}</text>`}return t}load(t){this._labels=t.columns.find(e=>e[0]===t.types.x),this._lines=t.columns.filter(e=>e[0]!==t.types.x).map(e=>{let s=t.names&&t.names[e[0]]||"",i=t.colors&&t.colors[e[0]]||"black";return new TLine(this._graph,e[0],s,i,e.slice(1))}),this._labels.shift(),this.rescale()}rescale(t=null,e=null){t=Math.floor(Math.min(Math.max(t||0,0),this._labels.length)),e=Math.ceil(Math.max(Math.min(e||this._labels.length,this._labels.length),0));let[s,i]=this._lines.filter(t=>t._enabled).reduce((s,i)=>{let[h,n]=i.mnmx(t,e);return[Math.min(h,s[0]),Math.max(n,s[1])]},[1/0,-1/0]),h=this._graph._mgHeight/(i-s),n=s;for(let t of this.lines())t.rescale(n,h)}lines(){return this._lines}static validateData(t){if(!t)return!1;for(let e of["columns","types"])if(!t[e])return!1;if(!t.columns.length)return!1;if(!t.types.x)return!1;for(let e in t.types)if(!["x","line"].includes(t.types[e]))return!1;return!0}}class TLine{constructor(t,e,s,i,h,n=0){this._el=null,this._enabled=!0,this._zoom=1,this._offset=0,this._graph=t,this._name=e,this._label=s,this._color=i,[this._min,this._max]=_mm(h),this._zoom=n||this._max/this._graph._mgHeight,this._data=h}mnmx(t,e){return _mm(this._data.slice(t,e))}get el(){if(this._el)return this._el;this._step=this._graph._width/this._data.length;let t=[];for(let e=0;e<this._data.length;e++)t.push(this._step*e+","+this._data[e]);return this._el=_nes("polyline"),this._el.setAttribute("vector-effect","non-scaling-stroke"),this._el.style=`transform-origin: 0 0;transition: 0.5s;fill:none;stroke:${this._color};stroke-width:1`,this._el.setAttribute("points",t.join(" ")),this.rescale(this._offset,this._zoom),this._el}rescale(t,e){this._offset=t,this._zoom=e,this._el&&(this._el.style.transform=`translateY(${this._graph._mgHeight+this._offset*this._zoom}px) scaleY(-${this._zoom})`)}toggle(){this._enabled=!this._enabled,this._el.style.opacity=this._enabled?1:0}}